# 領収書・請求書AI仕訳 Webアプリ

領収書や請求書の画像からAIで仕訳を推測し、会計ソフト用のCSVファイルを自動生成するWebアプリケーションです。

## 機能

- 📷 画像ファイル（PNG、JPG、JPEG）のアップロード
- 📄 PDFファイルのアップロード（OCR対応）
- 🔍 OCRによるテキスト抽出（日本語対応）
  - Google Cloud Vision API（推奨）
  - Tesseract OCR（フォールバック）
- 🤖 AIによる仕訳情報の自動推測
  - 会社名
  - 取引日
  - 金額
  - 消費税区分（内税/外税/自動判定）
  - 摘要
  - 勘定科目
- 🎯 立場選択（受領/発行）
- 📊 会計ソフト用CSVファイルの自動生成
  - 汎用CSV形式
  - マネーフォワード形式
  - freee形式
  - テキスト形式
- 🔗 **freee API直接登録**（証憑付き）
  - 会計事務所向け顧客選択機能
  - 複数顧客企業に対応
  - 勘定科目・取引先の自動取得
- 💾 ファイル名：`会社名_日付_output.csv`形式

## セットアップ

### 前提条件

- Python 3.8以上
- macOS（Homebrew使用）

### 1. 依存関係のインストール

```bash
# Tesseract（OCRエンジン）のインストール
brew install tesseract
brew install tesseract-lang

# Pythonパッケージのインストール
pip install -r requirements.txt
```

### 2. 環境変数の設定

```bash
# OpenAI APIキー
export OPENAI_API_KEY="your-openai-api-key"

# Google Cloud Vision API（オプション）
export GOOGLE_APPLICATION_CREDENTIALS="path/to/service-account.json"
```

### 3. アプリの起動

```bash
streamlit run app.py
```

ブラウザで `http://localhost:8501` にアクセスしてアプリを使用できます。

## 使い方

1. **ファイルアップロード**
   - 「画像またはPDFをアップロード」ボタンをクリック
   - 領収書・請求書の画像ファイルを選択（複数可）

2. **設定選択**
   - 立場：受領（費用）または発行（売上）
   - 消費税区分：自動判定/内税10%/外税10%/内税8%/外税8%

3. **出力形式選択**
   - 汎用CSV/TXT
   - マネーフォワードCSV/TXT
   - freee CSV/TXT
   - **freee API直接登録**（会計事務所向け）

4. **仕訳CSV作成**
   - 「仕訳処理を開始」ボタンをクリック
   - OCR処理が実行され、抽出されたテキストと推測結果が表示されます

5. **freee API直接登録の場合**
   - 顧客企業を選択
   - 勘定科目・取引先を選択
   - 「freeeに登録」ボタンで直接登録

## freee API連携

### 会計事務所向け機能

**複数顧客企業に対応したfreee API直接登録機能：**

- ✅ **顧客選択**: ドロップダウンで顧客企業を選択
- ✅ **自動取得**: 選択した顧客の勘定科目・取引先を自動取得
- ✅ **直接登録**: 仕訳データと証憑画像をfreeeに直接登録
- ✅ **証憑添付**: レシート画像を証憑として自動添付

### freee API設定

**Streamlit Secretsに以下を設定：**

```toml
FREEE_CLIENT_ID = "your_client_id"
FREEE_CLIENT_SECRET = "your_client_secret"
FREEE_ACCESS_TOKEN = "your_access_token"
```

**注意**: Company IDは顧客選択時に自動で設定されます。

### 使用方法

1. **freee API設定を取得**
   - freeeで会計事務所アカウントを作成
   - API設定でアプリケーションを作成
   - Client ID、Client Secret、Access Tokenを取得

2. **Streamlit Secretsに設定**
   - 上記の設定をStreamlit CloudのSecretsに追加

3. **アプリで使用**
   - 出力形式で「freee API直接登録」を選択
   - 顧客企業を選択
   - 勘定科目・取引先を選択
   - 「freeeに登録」ボタンで登録

## 対応する勘定科目

### 費用系（受領側）
- 研修費（講義、研修関連）
- 教育研修費（セミナー、教育関連）
- 旅費交通費（交通、タクシー関連）
- 通信費（通信、電話、郵便関連）
- 消耗品費（事務用品、文具関連）
- 会議費（会議、ミーティング関連）
- 交際費（接待、贈答関連）
- 広告宣伝費（広告、PR関連）
- 外注費（外部委託関連）
- 支払手数料（手数料関連）
- 仮払金（一時的な支払い）
- 修繕費（修理、メンテナンス関連）
- 仕入高（商品仕入れ関連）
- 減価償却費（資産の減価償却）

### 収入系（発行側）
- 売上高（商品・サービス販売）
- 雑収入（その他の収入）
- 受取手形（手形による回収）
- 売掛金（掛け売りによる回収）

## AI機能

- **GPT-4.1-nano**を使用した高精度な勘定科目推測
- 日本の会計実務に特化したプロンプト設計
- 郵便・配送サービスは自動的に「通信費」に分類
- 期間情報（x月分等）の摘要への自動反映
- **学習機能**: 過去の修正例を参考に精度向上

## 注意事項

- 画像の品質が良いほど、OCRの精度が向上します
- 手書き文字の認識精度は印刷文字より低くなります
- HEICファイルは現在対応していません（JPEGに変換してからアップロードしてください）
- 10%・8%混在レシートの場合は、手動で2仕訳に分けてください
- freee API利用には会計事務所アカウントが必要です

## トラブルシューティング

### OCRが動作しない場合

```bash
# Tesseractのインストール確認
tesseract --version

# 日本語言語パックの確認
tesseract --list-langs
```

### freee APIが動作しない場合

1. **会計事務所アカウント**でログインしているか確認
2. **API設定**が正しく取得されているか確認
3. **Streamlit Secrets**の設定を確認
4. **顧客企業**が正しく選択されているか確認 